<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Send Tickets</title>
    <style>
        table {
            border-collapse: collapse;
            margin-top: 10px;
        }

        table,
        th,
        td {
            border: 1px solid black;
            padding: 5px 10px;
        }
    </style>
</head>

<body>
    <h2>Upload CSV to Send Tickets</h2>
    <input type="file" id="csvFile" accept=".csv" />
    <div id="preview"></div>
    <button id="sendBtn" style="display:none;">Send Tickets</button>
    <pre id="output"></pre>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-functions.js";

        // TODO: Replace with your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBqWz16jm09OaaJ8JbkZIoeYsaS8C7WDl4",
            authDomain: "tickets-kokosai.firebaseapp.com",
            projectId: "tickets-kokosai",
            storageBucket: "tickets-kokosai.firebasestorage.app",
            messagingSenderId: "408725545221",
            appId: "1:408725545221:web:83cd8c7b008f881821576c",
        };

        const app = initializeApp(firebaseConfig);
        const functions = getFunctions(app);

        let recipients = [];

        function parseCSV(content) {
            const lines = content.trim().split("\n");
            const result = [];
            for (let line of lines) {
                const [email, type] = line.split(",").map(s => s.trim());
                if (email && type && !isNaN(type) && type >= 1 && type <= 9) {
                    result.push({ email, type: Number(type) });
                }
            }
            return result;
        }

        function showPreview(recipients) {
            const previewDiv = document.getElementById("preview");
            const sendBtn = document.getElementById("sendBtn");

            if (recipients.length === 0) {
                previewDiv.innerHTML = "<p>No valid rows found.</p>";
                sendBtn.style.display = "none";
                return;
            }

            let html = "<table><tr><th>Email</th><th>Type</th></tr>";
            recipients.forEach(r => {
                html += `<tr><td>${r.email}</td><td>${r.type}</td></tr>`;
            });
            html += "</table>";

            previewDiv.innerHTML = html;
            sendBtn.style.display = "inline-block";
        }

        // Automatically parse CSV when file is selected
        document.getElementById("csvFile").addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                recipients = parseCSV(e.target.result);
                showPreview(recipients);
                document.getElementById("output").textContent = "";
            };
            reader.readAsText(file);
        });

        document.getElementById("sendBtn").addEventListener("click", async () => {
            if (recipients.length === 0) return;

            document.getElementById("output").textContent = "Sending tickets...";
            try {
                const sendTickets = httpsCallable(functions, "sendTickets");
                const result = await sendTickets({ recipients });
                document.getElementById("output").textContent =
                    `Success! Sent ${result.data.count} tickets:\n` + result.data.tickets.join("\n");
            } catch (err) {
                console.error(err);
                document.getElementById("output").textContent = "Error: " + err.message;
            }
        });
    </script>
</body>

</html>